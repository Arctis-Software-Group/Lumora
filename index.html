<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Lumora</title>
    <meta name="description" content="Lumora - High-performance AI at a low cost" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="stylesheet" href="./src/styles/tokens.css" />
    <link rel="stylesheet" href="./src/styles/theme.css" />
    <link rel="stylesheet" href="./src/styles/layout.css" />
    <link rel="stylesheet" href="./src/styles/app.css" />
    <link rel="stylesheet" href="./src/styles/chat.css" />
    <link rel="stylesheet" href="./src/styles/glass.css" />
    <link rel="stylesheet" href="./src/styles/simple.css" />
    <link rel="stylesheet" href="./src/styles/fii.css" />
    <!-- Revamp overrides (loaded last) -->
    <link rel="stylesheet" href="./src/styles/revamp.css" />
    <link rel="stylesheet" href="./src/ui/rvi/style.css" />
    <link rel="stylesheet" href="./src/ui/rvi/themes/liquid-glass.css" />
  </head>
  <body>
    <a href="#input" class="skip-link">メインコンテンツへスキップ</a>
    <div id="bg-gradient" aria-hidden="true"></div>

    <header class="topbar" role="banner">
      <div class="topbar-inner">
        <div class="topbar-left">
          <button id="mobileMenuBtn" class="icon-btn mobile-only" aria-label="メニュー" aria-controls="sidebar" aria-expanded="false" title="メニュー">☰</button>
          <div class="brand-block" aria-label="Lumora ホーム">
            <div class="brand">Lumora</div>
            <div class="brand-tagline">Thoughtful AI workspace</div>
          </div>
        </div>
        <div class="topbar-right">
            <div class="controls">
              <div id="modelSelectorContainer" class="model-selector-container"><!-- JS で挿入 --></div>
              <div id="toneBadge" class="plan-badge" aria-live="polite" style="display:none;">Tone: Neutral</div>
              <div id="studyBadge" class="plan-badge" aria-live="polite" style="display:none;">Study Mode</div>
              <div id="medicalBadge" class="plan-badge" aria-live="polite" style="display:none;">Medical Mode</div>
              <div id="evoIndicator" class="plan-badge evo-indicator" aria-live="polite" style="display:none;" title="進化ログを表示/非表示">進化中… (0/0)</div>
            </div>
        </div>
      </div>
    </header>

    <div id="fiiRoot" class="fii-root" aria-label="Fluid Intelligence Interface"></div>
    <div class="container">
      <aside id="sidebar" class="sidebar" aria-label="会話の履歴とプロジェクト">
        <div class="sidebar-header">
          <section class="sidebar-section is-actions">
            <div class="sidebar-section-header">
              <span class="sidebar-heading">Workspace</span>
              <div class="sidebar-buttons">
                <button id="toggleSidebarBtn" class="icon-btn" title="サイドバーを折りたたむ" aria-label="サイドバーを折りたたむ">
                  <span class="chev">⟷</span>
                </button>
                <button id="newChatBtn" class="primary-btn">＋ 新しいチャット</button>
              </div>
            </div>
          </section>
          <section class="sidebar-section">
            <div class="sidebar-section-header">
              <span class="sidebar-heading">プロジェクト</span>
            </div>
            <div id="projectNav" class="project-nav"><!-- JS で挿入 --></div>
          </section>
          <section class="sidebar-section">
            <div class="sidebar-section-header">
              <span class="sidebar-heading">AI Tools</span>
            </div>
            <div class="ai-tools-nav">
              <a href="./agent.html" class="ai-tool-link" title="Lumora Agent - 自律型タスク遂行AI">
                <span class="ai-tool-icon">🧠</span>
                <span class="ai-tool-name">Agent</span>
                <span class="ai-tool-badge">Beta</span>
              </a>
            </div>
          </section>
          <section class="sidebar-section">
        </div>
        <div class="sidebar-scroll">
          <nav id="chatList" class="chat-list" aria-label="履歴一覧">
            <!-- JSで挿入 -->
          </nav>
        </div>
        <div class="sidebar-footer">
          <div id="userProfile" class="user-profile" aria-label="ユーザープロフィール">
            <div class="avatar-wrap">
              <img id="userAvatar" alt="ユーザー画像" />
              <div id="userAvatarFallback" class="avatar-fallback">U</div>
            </div>
            <div class="user-meta">
              <div id="userNameDisplay" class="user-name">ユーザー</div>
              <div id="planBadge" class="plan-badge" aria-live="polite">Free</div>
            </div>
          </div>
          <button id="settingsBtn" class="icon-btn" title="設定" aria-label="設定">
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M12 8.5A3.5 3.5 0 1 0 12 15.5 3.5 3.5 0 1 0 12 8.5zm8.94 2.56-.99-.57.02-.13a7.9 7.9 0 0 0-.5-1.2l.74-.9a.75.75 0 0 0-.06-.98l-1.07-1.07a.75.75 0 0 0-.98-.06l-.9.74c-.39-.22-.79-.39-1.2-.5l-.13-.02-.57-.99A.75.75 0 0 0 14.5 4h-1.5a.75.75 0 0 0-.66.38l-.57.99-.13.02c-.42.1-.82.28-1.21.5l-.9-.74a.75.75 0 0 0-.98.06L7.48 6.28a.75.75 0 0 0-.06.98l.74.9c-.22.39-.39.79-.5 1.2l-.02.13-.99.57A.75.75 0 0 0 6 11.5v1a.75.75 0 0 0 .38.66l.99.57.02.13c.1.42.28.82.5 1.21l-.74.9a.75.75 0 0 0 .06.98l1.07 1.07c.26.26.67.29.98.06l.9-.74c.39.22.79.39 1.2.5l.13.02.57.99c.13.23.37.38.64.38h1.5c.27 0 .51-.15.64-.38l.57-.99.13-.02c.42-.1.82-.28 1.21-.5l.9.74c.31.23.72.2.98-.06l1.07-1.07c.26-.26.29-.67.06-.98l-.74-.9c.22-.39.39-.79.5-1.2l.02-.13.99-.57c.23-.13.38-.37.38-.64v-1c0-.27-.15-.51-.38-.64z"/></svg>
          </button>
        </div>
      </aside>

      <main id="app" class="app" role="main" aria-live="polite">
        <section id="emptyState" class="empty-state" aria-label="空の状態">
          <div class="hero-frame">
            <div class="hero-main">
              <div class="hero-greeting">
                <h1>Hello I’m Lumora.</h1>
                <p>Is there anything I can help you with?</p>
              </div>
              <div class="hero-input" role="search">
                <div class="hero-menu-wrap">
                  <button id="newChatHero" class="sb-btn" title="新しいチャット" aria-label="新しいチャット">＋</button>
                  <div id="heroMenu" class="hero-menu" hidden>
                    <button id="attachBtn" class="menu-item" aria-label="写真とファイルを追加">📎 写真とファイルを追加</button>
                    <button id="thinkMoreBtn" class="menu-item" aria-label="より長く思考する">💡 より長く思考する</button>
                    <button id="studyModeBtn" class="menu-item" aria-label="Study Mode を切り替え" aria-pressed="false">📚 Study Mode をオン</button>
                    <button id="medicalModeBtn" class="menu-item" aria-label="Medical Mode を切り替え" aria-pressed="false">🩺 Medical Mode をオン</button>
                    <div class="menu-sep"></div>
                    <button id="reasoningBtn" class="menu-item has-sub" aria-haspopup="true" aria-expanded="false">⋯ 思考力を設定する ▸</button>
                    <div id="reasoningSub" class="submenu" hidden>
                      <button class="sub-item" data-effort="high">High</button>
                      <button class="sub-item" data-effort="medium">Medium</button>
                      <button class="sub-item" data-effort="low">Low</button>
                    </div>
                  </div>
                </div>
                <div id="heroPreview" class="attach-preview" hidden></div>
                <input id="heroInput" type="text" placeholder="アイデアや課題を入力してください" aria-label="アイデアや課題を入力してください" />
                <button id="heroMic" class="sb-icon" title="音声入力" aria-label="音声入力">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2z"/></svg>
                </button>
                <button id="heroSend" class="sb-send" title="送信" aria-label="送信">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
                </button>
              </div>
              <div class="hero-hints" aria-label="スターターヒント">
                <button class="hero-hint purpose-chip" data-suggest="プロジェクトのゴール: \n背景: \n制約: \n\n上記をもとに、次のアクションを段階的に提案してください。" title="戦略セッション">🧠 戦略セッション</button>
                <button class="hero-hint purpose-chip" data-suggest="ブランド/サービス: \n伝えたい価値: \n想定読者: \n\nトーン別に3つのメッセージ案を作成してください。" title="ブランドメッセージ">🎨 ブランドメッセージ</button>
                <button class="hero-hint purpose-chip" data-suggest="修正したいコード:\n```lang\n// ここにコード\n```\nエラーや改善したい点:\n\n読みやすいリファクタ案と理由を示してください。" title="コードアシスト">⚡️ コードアシスト</button>
              </div>
              <div class="hero-info-grid" aria-label="Lumora tips">
                <div class="hero-card gradient">
                  <h3>ショートカット</h3>
                  <p>⌘K でコマンドパレットを開き、チャット検索・モデル切り替え・設定に一瞬アクセスできます。</p>
                  <div class="hero-shortcuts">
                    <span class="shortcut-pill">⌘B サイドバー</span>
                    <span class="shortcut-pill">⌘J 入力欄</span>
                    <span class="shortcut-pill">⌘N 新規チャット</span>
                  </div>
                </div>
                <div class="hero-card board">
                  <h3>人気のブループリント</h3>
                  <div class="hero-blueprints">
                    <button class="hero-card-btn purpose-chip" data-suggest="リサーチ対象: \n知りたいこと: \n\n信頼できる情報源を引用しながら要点と次の打ち手をまとめてください。" title="リサーチ要約">🧭 リサーチ要約</button>
                    <button class="hero-card-btn purpose-chip" data-suggest="ローンチする製品/サービス: \nターゲット: \n時期: \n\nSNS・メール・LP向けのメッセージを3パターン提案してください。" title="ローンチ計画">🚀 ローンチ計画</button>
                    <button class="hero-card-btn purpose-chip" data-suggest="改善したいプロセス: \n現状の課題: \n制約: \n\n改善案を優先度順に示し、期待される効果を箇条書きでまとめてください。" title="改善ブリーフ">🛠️ 改善ブリーフ</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="messages" class="messages" aria-label="メッセージ一覧">
          <!-- JSでバブルを追加 -->
        </section>
        
        <button id="scrollBottomBtn" class="scroll-bottom" title="一番下へ" aria-label="一番下へ">↓</button>
        <!-- Bookmark Bubble: 現在のチャットをお気に入りに追加/解除 -->
        <button id="bookmarkBubble" class="bookmark-bubble" title="このチャットをお気に入り" aria-label="このチャットをお気に入り" hidden>☆</button>

        <footer id="composer" class="composer" aria-label="メッセージ作成欄" style="display:none;">
          <!-- 添付プレビュー（会話中） -->
          <div id="composerPreview" class="composer-attach-bar" hidden></div>
          <!-- メニュー（＋） -->
          <div class="composer-menu-wrap">
            <button id="composerPlus" class="icon-btn" title="ツール" aria-label="ツール">＋</button>
            <div id="composerMenu" class="hero-menu" hidden>
              <button id="composerAttachBtn" class="menu-item" aria-label="写真とファイルを追加">📎 写真とファイルを追加</button>
              <button id="composerThinkMoreBtn" class="menu-item" aria-label="より長く思考する">💡 より長く思考する</button>
              <button id="composerStudyModeBtn" class="menu-item" aria-label="Study Mode を切り替え" aria-pressed="false">📚 Study Mode をオン</button>
              <button id="composerMedicalModeBtn" class="menu-item" aria-label="Medical Mode を切り替え" aria-pressed="false">🩺 Medical Mode をオン</button>
              <div class="menu-sep"></div>
              <button id="composerReasoningBtn" class="menu-item has-sub" aria-haspopup="true" aria-expanded="false">⋯ 思考力を設定する ▸</button>
              <div id="composerReasoningSub" class="submenu" hidden>
                <button class="sub-item" data-effort="high">High</button>
                <button class="sub-item" data-effort="medium">Medium</button>
                <button class="sub-item" data-effort="low">Low</button>
              </div>
              <div class="menu-sep"></div>
              <button id="compTplSummarize" class="menu-item" aria-label="テンプレ: 要約">🧾 テンプレ: 要約</button>
              <button id="compTplTranslate" class="menu-item" aria-label="テンプレ: 翻訳">🌐 テンプレ: 翻訳</button>
              <button id="compTplExplain" class="menu-item" aria-label="テンプレ: 解説">📘 テンプレ: 解説</button>
              <button id="compTplPrompt" class="menu-item" aria-label="テンプレ: プロンプト作成">💡 テンプレ: プロンプト</button>
              <div class="menu-sep"></div>
              <div class="menu-heading">Lumora Canvas™</div>
              <label class="menu-check">
                <input type="checkbox" id="canvasEnableToggle" />
                <span>Canvas 機能を有効にする</span>
              </label>
              <div class="menu-radio-group" id="canvasModeOptions">
                <label><input type="radio" name="canvasMode" value="auto" /> 自動表示</label>
                <label><input type="radio" name="canvasMode" value="manual" /> 手動表示</label>
                <label><input type="radio" name="canvasMode" value="off" /> 無効化</label>
              </div>
            </div>
          </div>
          <textarea id="input" rows="1" placeholder="メッセージを入力（Enterで送信 / Shift+Enterで改行）" aria-label="メッセージを入力"></textarea>
          <div class="composer-actions">
            <button id="evoToggleBtn" class="icon-btn evo-toggle" title="進化ループ ON/OFF" aria-pressed="true">🔄 進化</button>
            <div id="charCount" class="char-count" aria-live="polite">0</div>
            <button id="micBtn" class="icon-btn" title="音声入力" aria-label="音声入力" aria-pressed="false">
              <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2z"/></svg>
            </button>
            <div id="micIndicator" class="mic-indicator" aria-live="assertive" hidden>
              <span class="dot"></span><span class="bars"></span><span class="label">録音中…</span>
            </div>
            <button id="sendBtn" class="send-btn" title="送信" aria-label="送信">↑</button>
          </div>
        </footer>
      </main>
    </div>

    <footer class="legal">
      <a href="./terms.html" target="_blank" rel="noopener">利用規約</a>
      <span>·</span>
      <a href="./privacy.html" target="_blank" rel="noopener">プライバシー</a>
      <span>·</span>
      <a href="./fup.html" target="_blank" rel="noopener">公正利用ポリシー</a>
    </footer>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div id="canvasBackdrop" class="canvas-backdrop" hidden></div>
    <aside id="canvasPanel" class="canvas-panel" hidden aria-label="Lumora Canvas">
      <div class="canvas-header">
        <div class="canvas-title-wrap">
          <span class="canvas-title">Lumora Canvas™</span>
          <span id="canvasMeta" class="canvas-meta">HTML</span>
        </div>
        <div class="canvas-header-actions">
          <button id="canvasDownloadBtn" class="canvas-btn" type="button" title="ダウンロード">💾</button>
          <button id="canvasCloseBtn" class="canvas-btn" type="button" title="閉じる">✕</button>
        </div>
      </div>
      <div class="canvas-body">
        <div class="canvas-pane editor">
          <div class="canvas-pane-header">
            <span>編集</span>
            <button id="canvasCopyBtn" class="canvas-link" type="button">コピー</button>
          </div>
          <textarea id="canvasEditor" spellcheck="false" aria-label="Canvas Editor"></textarea>
        </div>
        <div class="canvas-pane preview">
          <div class="canvas-pane-header">
            <span id="canvasPreviewLabel">プレビュー</span>
          </div>
          <div id="canvasPreviewArea" class="canvas-preview-area" role="presentation"></div>
        </div>
      </div>
    </aside>

    <!-- Evolution Log Panel (right side) -->
    <aside id="evoLogPanel" class="evo-log-panel" hidden>
      <div id="evoResizer" class="evo-resizer" role="separator" aria-label="進化ログの幅を変更" tabindex="0"></div>
      <div class="evo-log-header">
        <div class="title"><span class="dot"></span><span>進化ログ</span><span class="subtitle">改良の過程を可視化</span></div>
        <div class="right"><span class="stat">状態: <strong id="evoStatus">待機</strong></span><span id="evoModeChip" class="chip">進化</span><button id="evoLogClose" class="evo-log-close" title="閉じる">✕</button></div>
      </div>
      <div id="evoLogBody" class="evo-log-body" aria-live="polite"></div>
    </aside>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-content enhanced-modal">
        <header class="modal-header enhanced-header">
          <div class="header-content">
            <div class="header-icon">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M12 8.5A3.5 3.5 0 1 0 12 15.5 3.5 3.5 0 1 0 12 8.5zm8.94 2.56-.99-.57.02-.13a7.9 7.9 0 0 0-.5-1.2l.74-.9a.75.75 0 0 0-.06-.98l-1.07-1.07a.75.75 0 0 0-.98-.06l-.9.74c-.39-.22-.79-.39-1.2-.5l-.13-.02-.57-.99A.75.75 0 0 0 14.5 4h-1.5a.75.75 0 0 0-.66.38l-.57.99-.13.02c-.42.1-.82.28-1.21.5l-.9-.74a.75.75 0 0 0-.98.06L7.48 6.28a.75.75 0 0 0-.06.98l.74.9c-.22.39-.39.79-.5 1.2l-.02.13-.99.57A.75.75 0 0 0 6 11.5v1a.75.75 0 0 0 .38.66l.99.57.02.13c.1.42.28.82.5 1.21l-.74.9a.75.75 0 0 0 .06.98l1.07 1.07c.26.26.67.29.98.06l.9-.74c.39.22.79.39 1.2.5l.13.02.57.99c.13.23.37.38.64.38h1.5c.27 0 .51-.15.64-.38l.57-.99.13-.02c.42-.1.82-.28 1.21-.5l.9.74c.31.23.72.2.98-.06l1.07-1.07c.26-.26.29-.67.06-.98l-.74-.9c.22-.39.39-.79.5-1.2l.02-.13.99-.57c.23-.13.38-.37.38-.64v-1c0-.27-.15-.51-.38-.64z"/>
              </svg>
            </div>
            <div class="header-text">
              <h2 id="settingsTitle">設定</h2>
              <p class="header-subtitle">アプリの表示と動作をカスタマイズ</p>
            </div>
          </div>
          <button id="settingsClose" class="enhanced-close-btn" aria-label="閉じる">
            <svg viewBox="0 0 24 24" width="20" height="20">
              <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </header>
        
        <div class="modal-body enhanced-body">
          <!-- Settings Tabs Navigation -->
          <nav class="settings-tabs" role="tablist" aria-label="設定カテゴリ">
            <button class="tab-btn" id="tab-safety" role="tab" aria-selected="true" aria-controls="settings-safety">セーフティ/トーン</button>
            <button class="tab-btn" id="tab-appearance" role="tab" aria-selected="false" aria-controls="settings-appearance">外観</button>
            <button class="tab-btn" id="tab-experiments" role="tab" aria-selected="false" aria-controls="settings-experiments">実験</button>
            <button class="tab-btn" id="tab-pro" role="tab" aria-selected="false" aria-controls="settings-pro">Pro</button>
            <button class="tab-btn" id="tab-labs" role="tab" aria-selected="false" aria-controls="settings-labs">Labs</button>
            <button class="tab-btn" id="tab-profile" role="tab" aria-selected="false" aria-controls="settings-profile">プロフィール</button>
            <button class="tab-btn" id="tab-projects" role="tab" aria-selected="false" aria-controls="settings-projects">プロジェクト</button>
            <button class="tab-btn" id="tab-audio" role="tab" aria-selected="false" aria-controls="settings-audio">音声</button>
            <button class="tab-btn" id="tab-achievements" role="tab" aria-selected="false" aria-controls="settings-achievements">実績</button>
            <button class="tab-btn" id="tab-export" role="tab" aria-selected="false" aria-controls="settings-export">エクスポート</button>
            <button class="tab-btn" id="tab-data" role="tab" aria-selected="false" aria-controls="settings-data">データ管理</button>
          </nav>
          <!-- Safety Section -->
          <div class="settings-section" id="settings-safety" role="tabpanel" aria-labelledby="tab-safety">
            <div class="section-header">
              <div class="section-icon">🛡️</div>
              <div class="section-info">
                <h3>セーフティ / トーン</h3>
                <p>System Prompt と Emotion Guard の調整</p>
              </div>
            </div>
            <div class="section-content">
              <div class="field enhanced-field">
                <label for="systemPromptInput" class="field-label">
                  <span class="label-text">System Prompt</span>
                  <span class="label-description">AIの振る舞いを定義（空欄可、保存時に自動チェック）</span>
                </label>
                <textarea id="systemPromptInput" rows="5" class="enhanced-select" placeholder="例: あなたは礼儀正しく、根拠を簡潔に示して回答してください。"></textarea>
                <div id="systemPromptWarning" style="font-size:12px; color: var(--warning, #b45309); display:none; margin-top:6px;">不正な内容が検出されました。保存できません。</div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label">
                  <span class="label-text">Emotion Guard™</span>
                  <span class="label-description">口調・応答トーンの自動/手動調整（UIに反映）</span>
                </label>
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                  <label style="display:flex; gap:6px; align-items:center;">
                    <input type="radio" name="emotionMode" id="emotionModeOff" value="off" />
                    Off
                  </label>
                  <label style="display:flex; gap:6px; align-items:center;">
                    <input type="radio" name="emotionMode" id="emotionModeAuto" value="auto" />
                    Auto（入力から検出）
                  </label>
                  <label style="display:flex; gap:6px; align-items:center;">
                    <input type="radio" name="emotionMode" id="emotionModeManual" value="manual" />
                    Manual
                  </label>
                  <div class="custom-select-wrapper">
                    <select id="emotionStyleSelect" class="enhanced-select" title="トーンを選択">
                      <option value="neutral">Neutral（中立・簡潔）</option>
                      <option value="empathetic">Empathetic（共感的）</option>
                      <option value="cheerful">Cheerful（前向き）</option>
                      <option value="professional">Professional（落ち着いた専門調）</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Appearance Section -->
          <div class="settings-section" id="settings-appearance" role="tabpanel" aria-labelledby="tab-appearance">
            <div class="section-header">
              <div class="section-icon">🎨</div>
              <div class="section-info">
                <h3>外観</h3>
                <p>テーマとレイアウトの設定</p>
              </div>
            </div>
            <div class="section-content">
              <div class="field enhanced-field">
                <label for="themeSelect" class="field-label">
                  <span class="label-text">テーマ</span>
                  <span class="label-description">アプリの見た目を選択</span>
                </label>
                <div class="custom-select-wrapper">
                  <select id="themeSelect" class="enhanced-select">
                    <option value="system">システム設定に従う</option>
                    <option value="light">ライト</option>
                    <option value="dark">ダーク</option>
                  </select>
                </div>
              </div>
              <div class="field enhanced-field">
                <label class="field-label" for="simpleModeToggle">
                  <span class="label-text">シンプルモード</span>
                  <span class="label-description">フラットでミニマルなUI（Chatアプリ風の落ち着いた外観）</span>
                </label>
                <div>
                  <input id="simpleModeToggle" type="checkbox" class="toggle" />
                </div>
              </div>
              <div class="field enhanced-field">
                <label for="densitySelect" class="field-label">
                  <span class="label-text">密度</span>
                  <span class="label-description">コンポーネントの間隔を調整（コンパクト/ゆったり）</span>
                </label>
                <div class="custom-select-wrapper">
                  <select id="densitySelect" class="enhanced-select">
                    <option value="comfortable">ゆったり</option>
                    <option value="compact">コンパクト</option>
                  </select>
                </div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label" for="contrastToggle">
                  <span class="label-text">高コントラスト</span>
                  <span class="label-description">境界やテキストのコントラストを強調（アクセシビリティ向上）</span>
                </label>
                <div>
                  <input id="contrastToggle" type="checkbox" class="toggle" />
                </div>
              </div>
              
              <div class="field enhanced-field">
                <label for="widthRange" class="field-label">
                  <span class="label-text">メッセージ幅</span>
                  <span class="label-description">チャットエリアの幅を調整</span>
                </label>
                <div class="range-wrapper">
                  <input type="range" id="widthRange" class="enhanced-range" min="600" max="1100" step="20" value="840" />
                  <div class="range-value">
                    <span id="widthValue">840</span>px
                  </div>
                </div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label" for="asobiToggle">
                  <span class="label-text">Asobi Mode</span>
                  <span class="label-description">日替わりテーマと実績バッジでちょっと遊び心を</span>
                </label>
                <div>
                  <input id="asobiToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label" for="glassToggle">
                  <span class="label-text">Liquid Glass モード</span>
                  <span class="label-description">iOS / visionOS 風の半透明・ガラス調UI（実験的 / 既定はオフ）</span>
                </label>
                <div>
                  <input id="glassToggle" type="checkbox" class="toggle" />
                </div>
              </div>
            </div>
          </div>

          <!-- Pro Section -->
          <div class="settings-section" id="settings-pro" role="tabpanel" aria-labelledby="tab-pro">
            <div class="section-header">
              <div class="section-icon">💎</div>
              <div class="section-info">
                <h3>Lumora Pro：使用モデルの選択</h3>
                <p>モデルセレクターで「Lumora Pro (Multi)」を選ぶと、ここで選択したモデル（最大4）で同時回答します</p>
              </div>
            </div>
            <div class="section-content">
              <div class="field enhanced-field">
                <label class="field-label">
                  <span class="label-text">使用モデルの選択（最大4）</span>
                  <span class="label-description">Lumora 内のすべてのモデルから選択可能</span>
                </label>
                <div id="proModelList" class="pro-model-list" aria-live="polite"></div>
                <div id="proModelCount" style="font-size:12px; opacity:.7; margin-top:6px;">0 / 4 選択中</div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label" for="proIntegrateSelect">
                  <span class="label-text">統合モデル</span>
                  <span class="label-description">各モデルの回答を統合する際に使用（全モデルから選択可）</span>
                </label>
                <div class="custom-select-wrapper">
                  <select id="proIntegrateSelect" class="enhanced-select"></select>
                </div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label" for="proEvoToggle">
                  <span class="label-text">自己改良ループ（Lumora Pro Mode）</span>
                  <span class="label-description">4モデル応答 → Nano統合 → 改善ループ（ONで透明性ログを表示可）</span>
                </label>
                <div>
                  <input id="proEvoToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label" for="proEvoRoundsSelect">
                  <span class="label-text">改良回数</span>
                  <span class="label-description">自動/1/2/4 回。多いほど品質向上しやすい（遅くなります）</span>
                </label>
                <div class="custom-select-wrapper">
                  <select id="proEvoRoundsSelect" class="enhanced-select">
                    <option value="auto">自動</option>
                    <option value="1">1回</option>
                    <option value="2">2回</option>
                    <option value="4">4回</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Experiments Section -->
          <div class="settings-section" id="settings-experiments" role="tabpanel" aria-labelledby="tab-experiments">
            <div class="section-header">
              <div class="section-icon">🧪</div>
              <div class="section-info">
                <h3>実験的機能</h3>
                <p>新しいUI/UX改善を段階的に有効化</p>
              </div>
            </div>
            <div class="section-content">
              <div class="field enhanced-field">
                <label class="field-label" for="newUiToggle">
                  <span class="label-text">新UI/UXを有効化</span>
                  <span class="label-description">視認性・操作性の向上（フォーカスリング/スクロール/タイポなど）</span>
                </label>
                <div>
                  <input id="newUiToggle" type="checkbox" class="toggle" />
                </div>
              </div>
              <div class="field enhanced-field">
                <label class="field-label" for="fiiToggle">
                  <span class="label-text">Fluid Intelligence Interface (FII)</span>
                  <span class="label-description">非線形の知的グラフUI（実験・既定はオフ）</span>
                </label>
                <div>
                  <input id="fiiToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <div class="field enhanced-field">
                <label class="field-label" for="rviToggle">
                  <span class="label-text">Realtime Visual Intelligence (RVI)</span>
                  <span class="label-description">応答から視覚ブロック（要点/比較/手順 など）を抽出して表示（実験・既定はオン）</span>
                </label>
                <div>
                  <input id="rviToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <!-- RVI Test Area -->
              <div class="field enhanced-field" id="rviTestField">
                <label class="field-label" for="rviTestInput">
                  <span class="label-text">RVI テスト</span>
                  <span class="label-description">下の入力に RVI JSON ブロック（【RVI-JSON】...【/RVI-JSON】 や ```rvi-json ... ```）または RVI タグ（例: [rviKeypoints]）を含むテキストを貼り、解析/プレビューを押してください。</span>
                </label>
                <textarea id="rviTestInput" rows="6" class="enhanced-select" placeholder="例: \n【RVI-JSON】{\n  \"type\": \"keypoints\", \n  \"payload\": { \n    \"title\": \"要点\", \n    \"items\": [\"一つ目\", \"二つ目\"] \n  }\n}【/RVI-JSON】\n\nまたは: [rviKeypoints title='ToDo']\n- 仕様を確認\n- UIを実装\n[/rviKeypoints]"></textarea>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                  <button id="rviTestSampleJsonBtn" class="secondary-btn" type="button">サンプル(JSON)</button>
                  <button id="rviTestSampleTagBtn" class="secondary-btn" type="button">サンプル(タグ)</button>
                  <button id="rviDemoKeypointsBtn" class="secondary-btn" type="button">サンプル: 要点</button>
                  <button id="rviDemoStepsBtn" class="secondary-btn" type="button">サンプル: 手順</button>
                  <button id="rviDemoChecklistBtn" class="secondary-btn" type="button">サンプル: チェック</button>
                  <button id="rviDemoTimelineBtn" class="secondary-btn" type="button">サンプル: タイムライン</button>
                  <button id="rviDemoComparisonBtn" class="secondary-btn" type="button">サンプル: 比較</button>
                  <button id="rviDemoTradeoffsBtn" class="secondary-btn" type="button">サンプル: トレードオフ</button>
                  <button id="rviDemoCauseEffectBtn" class="secondary-btn" type="button">サンプル: 因果関係</button>
                  <button id="rviDemoMetricsBtn" class="secondary-btn" type="button">サンプル: 指標</button>
                  <button id="rviTestParseBtn" class="primary-btn" type="button">解析/プレビュー</button>
                  <button id="rviTestClearBtn" class="secondary-btn" type="button">クリア</button>
                </div>
                <div id="rviTestHost" class="rvi-test-host" style="margin-top:12px;">
                  <!-- Mimic a message bubble host for RVI insertion -->
                  <div class="bubble-main" id="rviTestBubbleHost">
                    <div class="content markdown" id="rviTestContent"></div>
                    <div class="meta" id="rviTestMeta">テストプレビュー</div>
                  </div>
                </div>
              </div>

              <div class="divider"></div>

              <!-- Micro-Pause Insight (Experimental) -->
              <div class="field enhanced-field">
                <label class="field-label" for="microPauseToggle">
                  <span class="label-text">Micro-Pause Insight™（実験）</span>
                  <span class="label-description">入力の短い一時停止（500ms〜2s）で自然な続き候補を2〜3件提示。クリックで挿入、無視可</span>
                </label>
                <div>
                  <input id="microPauseToggle" type="checkbox" class="toggle" />
                </div>
              </div>
              <div class="field-note" style="font-size:12px; color: var(--warning, #b45309); margin: 6px 0 0 2px;">
                注意: Micro-Pause Insight™は実験中の機能です。環境や混雑状況、モデルの応答性により「動作しない／候補が出ない」ことが非常に多くあります。今後のアップデートで安定性を改善予定です。
              </div>
              <div class="field enhanced-field">
                <label class="field-label" for="microPauseModelSelect">
                  <span class="label-text">Micro-Pause 用モデル</span>
                  <span class="label-description">低コストの軽量モデルを使用</span>
                </label>
                <div class="custom-select-wrapper">
                  <select id="microPauseModelSelect" class="enhanced-select">
                    <option value="lfm-7b">LFM-7B（軽量・高速）</option>
                    <option value="hunyuan-a13b-instruct">Hunyuan-A13B Instruct</option>
                    <option value="google/gemma-3n-e4b-it">Gemma 3N e4B IT（Free）</option>
                  </select>
                </div>
              </div>

              <div class="divider"></div>

              <!-- Lumora Canvas Settings (Experimental) -->
              <div class="field enhanced-field">
                <label class="field-label" for="canvasSettingsEnable">
                  <span class="label-text">Lumora Canvas™</span>
                  <span class="label-description">AI が生成した HTML / Markdown / Text を編集・プレビュー（コールアウト表示と自動起動）</span>
                </label>
                <div style="display:flex; flex-direction:column; gap:10px;">
                  <label class="menu-check" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="canvasSettingsEnable" />
                    <span>Canvas 機能を有効にする</span>
                  </label>
                  <div class="menu-radio-group" id="canvasSettingsModeGroup" style="display:flex; gap:14px; flex-wrap:wrap;">
                    <label><input type="radio" name="canvasSettingsMode" id="canvasSettingsModeAuto" value="auto" /> 自動表示</label>
                    <label><input type="radio" name="canvasSettingsMode" id="canvasSettingsModeManual" value="manual" /> 手動表示</label>
                    <label><input type="radio" name="canvasSettingsMode" id="canvasSettingsModeOff" value="off" /> 無効化</label>
                  </div>
                  <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button id="canvasTestHtml" class="secondary-btn">Canvas をテスト（HTML）</button>
                    <button id="canvasTestMarkdown" class="secondary-btn">Canvas をテスト（Markdown）</button>
                    <button id="canvasTestText" class="secondary-btn">Canvas をテスト（Text）</button>
                  </div>
                  <div class="field-note" style="font-size:12px; opacity:.7;">
                    自動表示は、AI応答に <code>[[canvasCallHtmlSite]]...[[/canvasCallHtmlSite]]</code> などのディレクティブが含まれている場合に発火します。
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Labs Section (Beta/Alpha/Research) -->
          <div class="settings-section" id="settings-labs" role="tabpanel" aria-labelledby="tab-labs">
            <div class="section-header">
              <div class="section-icon">🔬</div>
              <div class="section-info">
                <h3>Labs</h3>
                <p>Beta/Alpha/Research Preview の機能管理</p>
              </div>
            </div>
            <div class="section-content">
              <!-- Category toggles -->
              <div class="field enhanced-field">
                <label class="field-label" for="labsBetaToggle">
                  <span class="label-text">Beta 機能</span>
                  <span class="label-description">安定版に近い新機能。UI/UX 向上を中心に提供</span>
                </label>
                <div>
                  <input id="labsBetaToggle" type="checkbox" class="toggle" />
                </div>
              </div>
              <div class="field enhanced-field">
                <label class="field-label" for="labsAlphaToggle">
                  <span class="label-text">Alpha 機能</span>
                  <span class="label-description">動作が不安定な可能性のある早期プレビュー</span>
                </label>
                <div>
                  <input id="labsAlphaToggle" type="checkbox" class="toggle" />
                </div>
              </div>
              <div class="field enhanced-field">
                <label class="field-label" for="labsResearchToggle">
                  <span class="label-text">Research Preview</span>
                  <span class="label-description">研究目的の試験的機能（挙動変更の可能性あり）</span>
                </label>
                <div>
                  <input id="labsResearchToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <div class="divider"></div>

              <!-- Beta features -->
              <div class="field enhanced-field" data-labs-scope="beta">
                <label class="field-label" for="emotionUiToggle">
                  <span class="label-text">Emotion Adaptive UI（Beta）</span>
                  <span class="label-description">対話の感情に合わせてUIトーンを自動調整（落ち着き/共感/前向き/プロフェッショナル）。Emotion Guardの設定に連動</span>
                </label>
                <div>
                  <input id="emotionUiToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <div class="field enhanced-field" data-labs-scope="beta">
                <label class="field-label" for="trustLayerToggle">
                  <span class="label-text">Trust & Transparency Layer（Beta）</span>
                  <span class="label-description">応答ごとに「使用モデル」と「信頼度」を自然表示。Lumora Auto ルーティングにも対応</span>
                </label>
                <div>
                  <input id="trustLayerToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <div class="field enhanced-field" data-labs-scope="beta">
                <label class="field-label" for="confidenceToggle">
                  <span class="label-text">信頼度を数値で表示</span>
                  <span class="label-description">Confidence をパーセント表記でメタ情報に表示（Trust Layer が有効な場合）</span>
                </label>
                <div>
                  <input id="confidenceToggle" type="checkbox" class="toggle" />
                </div>
              </div>

              <!-- Alpha/Research placeholders for future -->
              <div class="field enhanced-field" data-labs-scope="alpha" style="opacity:.8;">
                <label class="field-label">
                  <span class="label-text">将来の Alpha 機能</span>
                  <span class="label-description">今後の更新で提供予定です</span>
                </label>
              </div>
              <div class="field enhanced-field" data-labs-scope="research" style="opacity:.8;">
                <label class="field-label">
                  <span class="label-text">将来の Research Preview</span>
                  <span class="label-description">今後の更新で提供予定です</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div class="settings-section" id="settings-profile" role="tabpanel" aria-labelledby="tab-profile">
            <div class="section-header">
              <div class="section-icon">👤</div>
              <div class="section-info">
                <h3>プロフィール</h3>
                <p>ユーザーネームと画像を設定</p>
              </div>
            </div>
            <div class="section-content">
              <div class="field enhanced-field">
                <label for="usernameInput" class="field-label">
                  <span class="label-text">ユーザーネーム</span>
                  <span class="label-description">メッセージの表示などに使用</span>
                </label>
                <input id="usernameInput" type="text" placeholder="例: Taro" class="enhanced-select" />
              </div>
              <div class="field enhanced-field">
                <label for="userImageInput" class="field-label">
                  <span class="label-text">ユーザー画像</span>
                  <span class="label-description">PNG/JPEG（正方形推奨）</span>
                </label>
                <input id="userImageInput" type="file" accept="image/*" />
                <div style="display:flex; align-items:center; gap:12px;">
                  <img id="userImagePreview" alt="プレビュー" style="width:48px; height:48px; border-radius:50%; border:1px solid var(--border); object-fit:cover; display:none;" />
                  <span id="userImageName" style="font-size:12px; opacity:.7;"></span>
                </div>
              </div>
          </div>
        </div>

          <!-- Projects Section (per-project defaults) -->
          <div class="settings-section" id="settings-projects" role="tabpanel" aria-labelledby="tab-projects">
            <div class="section-header">
              <div class="section-icon">🗂️</div>
              <div class="section-info">
                <h3>プロジェクト</h3>
                <p>プロジェクトごとの既定設定</p>
              </div>
            </div>
            <div class="section-content">
              <div id="projectManager"></div>
            </div>
          </div>

          <!-- Audio Section -->
          <div class="settings-section" id="settings-audio" role="tabpanel" aria-labelledby="tab-audio">
            <div class="section-header">
              <div class="section-icon">🔊</div>
              <div class="section-info">
                <h3>音声</h3>
                <p>読み上げの声と速度を設定</p>
              </div>
            </div>
            <div class="section-content">
              <div class="field enhanced-field">
                <label for="ttsVoiceSelect" class="field-label">
                  <span class="label-text">声の種類</span>
                  <span class="label-description">ブラウザ提供の音声を使用</span>
                </label>
                <div class="custom-select-wrapper">
                  <select id="ttsVoiceSelect" class="enhanced-select"></select>
                </div>
              </div>
              <div class="field enhanced-field">
                <label for="ttsRateRange" class="field-label">
                  <span class="label-text">読み上げ速度</span>
                  <span class="label-description">0.5〜1.5（標準は1.0）</span>
                </label>
                <div class="range-wrapper">
                  <input type="range" id="ttsRateRange" class="enhanced-range" min="0.5" max="1.5" step="0.1" value="1" />
                  <div class="range-value"><span id="ttsRateValue">1.0</span>x</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Achievements (Asobi) -->
          <div class="settings-section" id="settings-achievements" role="tabpanel" aria-labelledby="tab-achievements">
            <div class="section-header">
              <div class="section-icon">🏅</div>
              <div class="section-info">
                <h3>実績（Asobi）</h3>
                <p>遊び心のバッジを集めましょう</p>
              </div>
            </div>
            <div class="section-content">
              <div id="achievements" class="achievements" aria-live="polite"></div>
            </div>
          </div>

          <!-- Export/Import Section -->
          <div class="settings-section" id="settings-export" role="tabpanel" aria-labelledby="tab-export">
            <div class="section-header">
              <div class="section-icon">📤</div>
              <div class="section-info">
                <h3>エクスポート / インポート</h3>
                <p>会話データをバックアップ・復元</p>
              </div>
            </div>
            <div class="section-content">
              <div class="field enhanced-field">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button id="exportCurrentBtn" class="secondary-btn">現在の会話をエクスポート（JSON）</button>
                  <button id="exportCurrentMdBtn" class="secondary-btn">現在の会話をエクスポート（Markdown）</button>
                  <button id="exportAllBtn" class="secondary-btn">全会話をエクスポート（JSON）</button>
                  <button id="importBtn" class="primary-btn">インポート（JSON）</button>
                </div>
                <input id="importFileInput" type="file" accept="application/json" hidden />
              </div>
            </div>
          </div>

          <!-- Data Management Section -->
          <div class="settings-section danger-section" id="settings-data" role="tabpanel" aria-labelledby="tab-data">
            <div class="section-header">
              <div class="section-icon">🗑️</div>
              <div class="section-info">
                <h3>データ管理</h3>
                <p>会話履歴の削除と管理</p>
              </div>
            </div>
            <div class="section-content">
              <div class="danger-actions">
                <button id="deleteCurrentBtn" class="enhanced-danger-btn">
                  <svg viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                  この会話を削除
                </button>
                <button id="deleteAllBtn" class="enhanced-danger-btn critical">
                  <svg viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M15 4V3c0-.55-.45-1-1-1h-4c-.55 0-1 .45-1 1v1H5c-.55 0-1 .45-1 1s.45 1 1 1h1v13c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V6h1c.55 0 1-.45 1-1s-.45-1-1-1h-4zM11 3h2v1h-2V3zm6 3v13H7V6h10z"/>
                  </svg>
                  全履歴を削除
                </button>
              </div>
              <div class="warning-text">
                <p>⚠️ 削除された会話は復元できません</p>
              </div>
            </div>
          </div>
        </div>

        
        
        <footer class="modal-footer enhanced-footer">
          <div class="footer-actions">
            <button id="settingsCancel" class="secondary-btn">キャンセル</button>
            <button id="settingsSave" class="enhanced-save-btn">
              <svg viewBox="0 0 24 24" width="16" height="16">
                <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              設定を保存
            </button>
          </div>
        </footer>
      </div>
    </div>

    <script type="module" src="./src/app/main.js"></script>
  </body>
  </html>
